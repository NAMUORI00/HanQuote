<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>HanQuote — 오늘의 명언</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <header class="header" role="banner">
      <h1 class="header__title">HanQuote</h1>
      <p class="header__subtitle">원문과 한국어 번역으로 매일 한 문장</p>
    </header>

    <main class="main" role="main" aria-label="명언 목록">
      <h2 class="visually-hidden">최신 명언</h2>
      <section id="latest" aria-live="polite" aria-busy="true"></section>
    </main>

    <footer class="footer" role="contentinfo">
      <p class="footer__paragraph">
        데이터 출처: <a href="https://api.quotable.io" target="_blank" rel="noreferrer" class="footer__link">Quotable</a>
        • 코드: <a href="https://github.com/" target="_blank" rel="noreferrer" class="footer__link">GitHub</a>
      </p>
      <p id="updated" class="footer__updated"></p>
    </footer>

    <script>
      /**
       * Main application logic
       * Follows modern JavaScript conventions with proper error handling
       */

      // Constants
      const QUOTES_DATA_URL = './data/quotes.json';
      const MAX_QUOTES_DISPLAY = 10;
      const LOCALE = 'ko-KR';

      // DOM Elements
      const quotesContainer = document.getElementById('latest');
      const updatedElement = document.getElementById('updated');

      /**
       * Escapes HTML special characters to prevent XSS
       * @param {string} str - String to escape
       * @returns {string} Escaped string
       */
      function escapeHtml(str) {
        const htmlEscapeMap = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        };
        return (str || '').replace(/[&<>"']/g, (char) => htmlEscapeMap[char]);
      }

      /**
       * Renders a single quote card
       * @param {Object} quote - Quote object
       * @returns {string} HTML string for quote card
       */
      function renderQuoteCard(quote) {
        const author = quote.author ? escapeHtml(quote.author) : 'Unknown';
        const sourceText = quote.source_name ? escapeHtml(quote.source_name) : '—';
        const sourceLink = quote.source_url
          ? `, <a href="${escapeHtml(quote.source_url)}" target="_blank" rel="noreferrer" class="quote-card__meta-link">링크</a>`
          : '';

        return `
          <article class="quote-card">
            <blockquote class="quote-card__blockquote">${escapeHtml(quote.text_original)}</blockquote>
            <p class="quote-card__meta">${author} · ${sourceText}${sourceLink}</p>
          </article>
        `;
      }

      /**
       * Displays loading state
       */
      function showLoading() {
        quotesContainer.innerHTML = '<p class="loading">명언을 불러오는 중...</p>';
        quotesContainer.setAttribute('aria-busy', 'true');
      }

      /**
       * Displays error state
       * @param {string} message - Error message
       */
      function showError(message = '데이터를 불러올 수 없습니다.') {
        quotesContainer.innerHTML = `<p class="error">${escapeHtml(message)}</p>`;
        quotesContainer.setAttribute('aria-busy', 'false');
      }

      /**
       * Displays quotes
       * @param {Array} quotes - Array of quote objects
       */
      function displayQuotes(quotes) {
        if (!quotes || quotes.length === 0) {
          showError('명언이 없습니다.');
          return;
        }

        // Sort by fetched_at descending (newest first)
        const sortedQuotes = quotes.sort((a, b) =>
          new Date(b.fetched_at) - new Date(a.fetched_at)
        );

        // Get most recent quotes
        const recentQuotes = sortedQuotes.slice(0, MAX_QUOTES_DISPLAY);

        // Render quote cards
        quotesContainer.innerHTML = recentQuotes.map(renderQuoteCard).join('');
        quotesContainer.setAttribute('aria-busy', 'false');

        // Update last updated timestamp
        if (sortedQuotes[0]?.fetched_at) {
          const lastUpdated = new Date(sortedQuotes[0].fetched_at);
          updatedElement.textContent = `마지막 갱신: ${lastUpdated.toLocaleString(LOCALE)}`;
        }
      }

      /**
       * Fetches and displays quotes
       */
      async function loadQuotes() {
        showLoading();

        try {
          const response = await fetch(QUOTES_DATA_URL, {
            cache: 'no-cache',
            headers: {
              'Accept': 'application/json'
            }
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const quotes = await response.json();
          displayQuotes(quotes);

        } catch (error) {
          console.error('Failed to load quotes:', error);
          showError(`오류: ${error.message}`);
        }
      }

      // Initialize application
      loadQuotes();
    </script>
  </body>
  </html>
